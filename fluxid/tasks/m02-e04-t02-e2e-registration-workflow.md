---
id: m02-e04-t02
epic: m02-e04
title: E2E Test - Complete Registration Workflow (No Mocks)
status: pending
priority: high
tdd_phase: red
---

# Task: E2E Test - Complete Registration Workflow (No Mocks)

## Objective
Validate complete user registration workflow end-to-end using real Django backend, real SQLite database, real JWT authentication, and real iOS app with no mocks. Tests cover registration, auto-login, profile auto-creation, and UI state transitions.

## Acceptance Criteria
- [ ] Maestro flow: `m02_e04_registration_complete.yaml`
- [ ] Test steps:
  1. Start real Django backend (via helper script)
  2. Launch iOS app (fresh install state)
  3. Assert header shows "Login" button (not authenticated)
  4. Tap "Login" button
  5. Tap "Register" link
  6. Assert registration screen appears
  7. Enter email: `newuser@pockitflyer.test`
  8. Enter password: `NewPass123!`
  9. Enter display name: `Test User`
  10. Tap "Register" button
  11. Assert loading indicator appears
  12. Assert registration succeeds (no error messages)
  13. Assert user auto-logged in (JWT token stored)
  14. Assert header shows profile avatar (authenticated state)
  15. Tap profile avatar in header
  16. Assert profile screen loads
  17. Assert display name matches: "Test User"
  18. Assert email matches: `newuser@pockitflyer.test`
  19. Assert profile picture is placeholder (no picture uploaded yet)
  20. Assert bio is empty (new profile)
  21. Verify backend database:
      - User account created with hashed password
      - Profile auto-created with correct user_id
      - Privacy settings auto-created with default values
  22. Cleanup: delete test user, stop backend
- [ ] Real service validations:
  - Backend registration API creates user account
  - Password hashed correctly (Django password hashers)
  - JWT token generated and returned in response
  - Token stored in iOS secure storage
  - Profile auto-created via Django signals
  - Privacy settings auto-created via Django signals
- [ ] UI state validations:
  - Header transitions from "Login" button to profile avatar
  - Profile avatar displays placeholder correctly
  - Navigation from avatar to profile screen works
  - All profile fields accurate (name, email, placeholder picture)
- [ ] Error handling tests (separate Maestro flows):
  - Duplicate email → clear error message: "Email already registered"
  - Invalid email format → validation error: "Invalid email"
  - Weak password → validation error: "Password too weak"
  - Network failure → error message with retry button
- [ ] All Maestro tests tagged with appropriate TDD markers after passing

## Test Coverage Requirements
- Complete vertical slice: iOS registration screen → REST API → Django user creation → SQLite → JWT generation → profile/settings auto-creation
- Email validation (frontend and backend)
- Password validation (frontend and backend)
- Display name validation (required, max length)
- JWT token generation and storage
- Profile auto-creation via signals
- Privacy settings auto-creation via signals
- Header UI state transition (login button ↔ avatar)
- Navigation to profile screen after registration
- Error handling for all validation failures
- Network error handling with retry
- Database state verification (user, profile, settings created)

## Files to Modify/Create
- `maestro/flows/m02-e04/registration_complete_workflow.yaml`
- `maestro/flows/m02-e04/registration_duplicate_email.yaml`
- `maestro/flows/m02-e04/registration_invalid_email.yaml`
- `maestro/flows/m02-e04/registration_weak_password.yaml`
- `maestro/flows/m02-e04/registration_network_error.yaml`
- `pockitflyer_backend/scripts/verify_user_created.py` (helper script for database verification)
- `pockitflyer_backend/scripts/delete_test_user.py` (cleanup helper)

## Dependencies
- m02-e04-t01 (M02 E2E test data infrastructure)
- m02-e01-t03 (Backend registration API)
- m02-e01-t07 (Frontend registration screen)
- m02-e01-t09 (Frontend header auth UI)
- m02-e02-t01 (Profile auto-creation on registration)
- m02-e03-t01 (Privacy settings auto-creation)

## Notes
**Critical: NO MOCKS**
- Real Django server running on localhost
- Real SQLite database with test data
- Real JWT authentication (tokens generated by backend)
- Real iOS app making actual HTTP requests
- Real iOS secure storage for token persistence

**Helper Scripts** (see CONTRIBUTORS.md):
- `./scripts/start_backend_e2e.sh` - Starts backend in detached mode
- `./scripts/start_app_e2e.sh` - Builds and launches iOS app
- `./scripts/stop_all_e2e.sh` - Clean shutdown of all services

**Registration Validation Rules** (must match backend and frontend):
- Email: Valid email format, unique (not already registered)
- Password: Minimum 8 characters, at least 1 uppercase, 1 lowercase, 1 number
- Display name: Required, 1-50 characters, any Unicode characters allowed

**Database Verification Strategy**:
After registration, verify database state:
```python
# pockitflyer_backend/scripts/verify_user_created.py
user = User.objects.get(email='newuser@pockitflyer.test')
assert user.check_password('NewPass123!')  # Password hashed correctly
assert user.profile.display_name == 'Test User'  # Profile auto-created
assert user.profile.bio == ''  # Empty bio
assert user.privacy_settings.email_permission == True  # Default privacy settings
```

**JWT Token Verification**:
- Token stored in iOS Keychain (secure storage)
- Token includes user_id, email, expiration
- Token valid for 7 days (configurable in settings)
- Token used for subsequent authenticated requests

**Auto-Creation Verification**:
- Profile auto-created via `post_save` signal on User model
- Privacy settings auto-created via `post_save` signal on Profile model
- All foreign keys linked correctly (profile.user_id = user.id)

**Error Message Validation**:
- Duplicate email: Backend returns 400 with clear message
- Invalid email: Frontend validates before API call (instant feedback)
- Weak password: Frontend validates before API call (instant feedback)
- Network error: iOS shows error alert with "Retry" button

**UI State Transitions**:
1. Initial state: Header shows "Login" button, user not authenticated
2. Registration succeeds: Header shows profile avatar (placeholder), user authenticated
3. Avatar tappable: Navigates to profile screen
4. Profile screen: Shows display name, email, placeholder picture, empty bio

**Performance Expectations**:
- Registration API call: <2 seconds
- Auto-login after registration: <1 second
- Header UI update: Immediate (no flicker)
- Profile screen load: <1 second

**Cleanup Strategy**:
- Delete test user after each test run
- Cascading delete removes profile, privacy settings, JWT tokens
- Use helper script: `python manage.py delete_test_user newuser@pockitflyer.test`

**Edge Cases to Test** (separate Maestro flows):
1. Registration with existing email (duplicate)
2. Registration with malformed email (invalid format)
3. Registration with weak password (fails validation)
4. Registration during network outage (timeout, retry)
5. Registration with very long display name (50 character limit)
6. Registration with special characters in display name (Unicode support)

**Success Indicators**:
- User created in database with hashed password ✅
- Profile auto-created with correct display name ✅
- Privacy settings auto-created with defaults ✅
- JWT token generated and stored in iOS Keychain ✅
- Header shows profile avatar (not login button) ✅
- Profile screen accessible and accurate ✅
- All error cases handled gracefully ✅
