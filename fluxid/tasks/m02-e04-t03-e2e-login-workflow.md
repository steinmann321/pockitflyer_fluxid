---
id: m02-e04-t03
epic: m02-e04
title: E2E Test - Complete Login Workflow (No Mocks)
status: pending
priority: high
tdd_phase: red
---

# Task: E2E Test - Complete Login Workflow (No Mocks)

## Objective
Validate complete user login workflow end-to-end using real Django backend, real JWT authentication, and real iOS app with no mocks. Tests cover login, token storage, authentication state, and logout workflows.

## Acceptance Criteria
- [ ] Maestro flow: `m02_e04_login_complete.yaml`
- [ ] Test steps:
  1. Start real Django backend (via helper script)
  2. Seed M02 E2E test data (30+ test users)
  3. Launch iOS app (fresh install state, NOT authenticated)
  4. Assert header shows "Login" button (unauthenticated state)
  5. Tap "Login" button
  6. Assert login screen appears
  7. Enter email: `test_user_001@pockitflyer.test`
  8. Enter password: `TestPass123!`
  9. Tap "Login" button
  10. Assert loading indicator appears
  11. Assert login succeeds (no error messages)
  12. Assert header shows profile avatar (authenticated state)
  13. Tap profile avatar in header
  14. Assert profile screen loads
  15. Assert profile data matches test_user_001 (display name, email, profile picture if present)
  16. Navigate back to feed
  17. Assert feed still loads (authenticated user can browse M01 features)
  18. Tap profile avatar again
  19. Tap "Logout" button (on profile screen)
  20. Assert logout confirmation dialog appears
  21. Confirm logout
  22. Assert header shows "Login" button again (unauthenticated state)
  23. Assert profile screen no longer accessible
  24. Verify backend: JWT token invalidated or cleared
  25. Cleanup: stop backend
- [ ] Real service validations:
  - Backend login API validates credentials
  - Password verified using Django password hashers
  - JWT token generated and returned in response
  - Token stored in iOS Keychain (secure storage)
  - Token included in Authorization header for authenticated requests
  - Logout clears token from iOS Keychain
- [ ] UI state validations:
  - Header transitions: Login button → Avatar → Login button (after logout)
  - Login screen validation errors show inline
  - Loading states during API calls
  - Profile screen accessible only when authenticated
- [ ] Error handling tests (separate Maestro flows):
  - Wrong password → error message: "Invalid credentials"
  - Non-existent email → error message: "Invalid credentials" (no email enumeration)
  - Empty email → validation error: "Email required"
  - Empty password → validation error: "Password required"
  - Network failure → error message with retry button
- [ ] Token persistence test (separate Maestro flow):
  - Login → app backgrounds → app foregrounds → still authenticated
  - Login → force quit app → relaunch app → still authenticated (covered in t06)
- [ ] All Maestro tests tagged with appropriate TDD markers after passing

## Test Coverage Requirements
- Complete vertical slice: iOS login screen → REST API → Django authentication → JWT generation → token storage
- Email/password validation (frontend and backend)
- Password verification against hashed database value
- JWT token generation with correct payload (user_id, email, exp)
- Token storage in iOS Keychain
- Token retrieval for authenticated requests
- Logout workflow (token removal)
- Header UI state transitions
- Profile access control (authenticated vs unauthenticated)
- Error handling for invalid credentials
- Network error handling with retry
- Token persistence during app lifecycle (background/foreground)

## Files to Modify/Create
- `maestro/flows/m02-e04/login_complete_workflow.yaml`
- `maestro/flows/m02-e04/login_wrong_password.yaml`
- `maestro/flows/m02-e04/login_nonexistent_email.yaml`
- `maestro/flows/m02-e04/login_empty_fields.yaml`
- `maestro/flows/m02-e04/login_network_error.yaml`
- `maestro/flows/m02-e04/logout_workflow.yaml`
- `maestro/flows/m02-e04/login_token_persistence_lifecycle.yaml`

## Dependencies
- m02-e04-t01 (M02 E2E test data infrastructure with test users)
- m02-e01-t04 (Backend login API)
- m02-e01-t08 (Frontend login screen)
- m02-e01-t09 (Frontend header auth UI)
- m02-e01-t05 (Token storage service)
- m02-e01-t06 (Authentication state management)

## Notes
**Critical: NO MOCKS**
- Real Django server running on localhost
- Real SQLite database with test users
- Real JWT authentication (tokens generated by backend)
- Real iOS app making actual HTTP requests
- Real iOS Keychain for token storage

**Helper Scripts** (see CONTRIBUTORS.md):
- `./scripts/start_backend_e2e.sh` - Starts backend in detached mode
- `./scripts/start_app_e2e.sh` - Builds and launches iOS app
- `./scripts/stop_all_e2e.sh` - Clean shutdown of all services

**Test User Credentials**:
- Email: `test_user_001@pockitflyer.test` (and 002-030)
- Password: `TestPass123!` (same for all test users)
- Users seeded by `seed_m02_e2e_data` command

**Login Validation Rules**:
- Email: Valid email format, must exist in database
- Password: Must match hashed password in database
- Both fields required (frontend validation)

**JWT Token Structure**:
```json
{
  "user_id": 1,
  "email": "test_user_001@pockitflyer.test",
  "exp": 1735689600,  // Unix timestamp (7 days from issue)
  "iat": 1735084800   // Issued at timestamp
}
```

**Token Storage Verification**:
- iOS Keychain used for secure storage (not UserDefaults)
- Token persists across app restarts
- Token cleared on logout
- Token included in all authenticated API requests (Authorization: Bearer <token>)

**Authentication State Management**:
- App maintains in-memory auth state (isAuthenticated boolean)
- State synced with token presence in Keychain
- State checked on app launch (token in Keychain → auto-authenticate)
- State updated on login/logout

**Logout Workflow**:
1. User taps "Logout" button on profile screen
2. Confirmation dialog appears: "Are you sure you want to logout?"
3. User confirms
4. Token cleared from iOS Keychain
5. Auth state updated: `isAuthenticated = false`
6. UI updates: Header shows "Login" button (not avatar)
7. User redirected to feed (still accessible anonymously)
8. Profile screen no longer accessible (requires auth)

**Error Message Standards**:
- Invalid credentials (wrong password or non-existent email): "Invalid email or password" (no email enumeration vulnerability)
- Empty email: "Email is required"
- Empty password: "Password is required"
- Network error: "Unable to connect. Please check your connection and try again."

**Security Considerations**:
- No email enumeration: Same error message for wrong password and non-existent email
- Password never logged or exposed in error messages
- Token transmitted over HTTPS only (enforced in production)
- Token stored securely in iOS Keychain (not UserDefaults)

**Performance Expectations**:
- Login API call: <3 seconds
- Token storage: <100ms
- Header UI update: Immediate (no flicker)
- Profile screen load after login: <2 seconds

**UI State Transitions**:
1. Unauthenticated state: Header shows "Login" button
2. Login succeeds: Header shows profile avatar (placeholder or user picture)
3. Logout succeeds: Header shows "Login" button again
4. Profile screen: Accessible only when authenticated

**Token Lifecycle Testing**:
- Login → Token stored → App backgrounds → App foregrounds → Token still valid → Still authenticated
- Login → Token stored → App force quit → App relaunched → Token still valid → Auto-authenticate (covered in t06)
- Token expiration handling (covered in t08)

**Edge Cases to Test** (separate Maestro flows):
1. Login with wrong password → error message, no auth state change
2. Login with non-existent email → error message, no auth state change
3. Login with empty email → validation error, no API call
4. Login with empty password → validation error, no API call
5. Login during network outage → timeout error, retry button
6. Logout while network unavailable → still clears local token, logout succeeds
7. Login → background app → wait 1 minute → foreground → still authenticated

**Success Indicators**:
- Login succeeds with valid credentials ✅
- JWT token generated and stored in Keychain ✅
- Header shows profile avatar after login ✅
- Profile screen accessible after login ✅
- Logout clears token and auth state ✅
- Header shows login button after logout ✅
- All error cases handled gracefully ✅
- Token persists during app lifecycle ✅
